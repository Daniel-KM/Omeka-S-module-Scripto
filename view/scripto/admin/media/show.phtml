<?php 
$this->headLink()->appendStylesheet($this->assetUrl('vendor/featherlight/featherlight.min.css', 'Scripto'));
$this->headLink()->appendStylesheet($this->assetUrl('css/scripto.css', 'Scripto'));
$this->headScript()->appendFile($this->assetUrl('vendor/jquery-panzoom/jquery.panzoom.min.js', 'Scripto'));
$this->headScript()->appendFile($this->assetUrl('vendor/featherlight/featherlight.min.js', 'Scripto'));
$this->headScript()->appendFile($this->assetUrl('js/media-review.js', 'Scripto'));
$this->headScript()->appendFile($this->assetUrl('js/scripto.js', 'Scripto'));
$this->htmlElement('body')->appendAttribute('class', 'scripto media show');
$mediaType = $media->mediaType();
$mediaIsImage = ((strpos($mediaType, 'image')) !== false);
?>

<?php echo $this->pageTitle($media->displayTitle(), 1, $this->translate(sprintf('Scripto: %s', 'Media')), $this->translate('Review')); ?>

<?php echo $this->scripto()->adminLoginBar(); ?>

<?php echo $this->scripto()->adminBreadcrumbs(); ?>

<?php echo $this->form()->openTag($form); ?>
<?php echo $this->formElement($form->get('mediaform_csrf')); ?>

<div id="page-actions">
    <div id="page-action-menu">
        <?php if ($this->scripto()->apiClient()->userIsLoggedIn()): ?>
        <?php echo $this->formCheckbox($form->get('is_watched')); ?>
        <?php endif; ?>
        <?php echo $this->hyperlink($this->translate('Revision history'), $this->url('admin/scripto-media-id', ['action' => 'revision'], true), ['class' => 'button']); ?>
        </ul>
        <button type="submit"><?php echo $this->translate('Save'); ?></button>
    </div>
</div>

<?php
$previous = $sMedia->previousScriptoMedia();
$next = $sMedia->nextScriptoMedia();
?>
<nav class="pagination" role="navigation">
    <?php if ($previous): ?>
    <?php echo $this->hyperlink('', $previous->adminUrl(), ['class' => 'previous o-icon-prev button', 'title' => $this->translate('Previous')]); ?>
    <?php else: ?>
    <span class="previous o-icon-prev button inactive"></span>
    <?php endif; ?>
    <?php if ($next): ?>
    <?php echo $this->hyperlink('', $next->adminUrl(), ['class' => 'next o-icon-next button', 'title' => $this->translate('Next')]); ?>
    <?php else: ?>
    <span class="next o-icon-next button inactive"></span>
    <?php endif; ?>
    <span class="row-count"><?php echo sprintf($this->translate('%s of %s'), $sMedia->position(), $sMedia->scriptoItem()->mediaCount()); ?></span>
</nav>

<?php echo $this->sectionNav([
    'wikitext' => $this->translate('Wikitext'),
    'html' => $this->translate('HTML'),
]); ?>

<div id="wikitext" class="active section">
    <div class="wikitext-featherlight horizontal">
        <h3><?php echo $media->displayTitle(); ?></h3>
        <button class="full-screen"><?php echo $this->translate('Go full screen'); ?></button>
        <div class="layout">
            <label><?php echo $this->translate('Layout'); ?></label>
            <button name="horizontal" class="horizontal active" aria-label="<?php echo $this->translate('Horizontal view'); ?>" title="<?php echo $this->translate('Horizontal view'); ?>" disabled></button>
            <button name="vertical" class="vertical" aria-label="<?php echo $this->translate('Vertical view'); ?>" title="<?php echo $this->translate('Vertical view'); ?>"></button>
        </div>
        <div class="wikitext-flex">
            <div class="textarea-flex">
                <textarea disabled><?php echo $sMedia->pageWikitext(); ?></textarea>
            </div>
            <div class="panzoom-container <?php echo ($mediaIsImage) ? 'image' : ''; ?>">
                <?php echo $media->render(['link' => null]); ?>
                <?php if ($mediaIsImage): ?>
                <div class="zoom-controls">
                    <button class="zoom-in" aria-label="<?php echo $this->translate('Zoom in'); ?>" title="<?php echo $this->translate('Zoom in'); ?>"></button>
                    <button class="zoom-out" aria-label="<?php echo $this->translate('Zoom out'); ?>" title="<?php echo $this->translate('Zoom out'); ?>"></button>
                    <button class="rotate-right" aria-label="<?php echo $this->translate('Rotate right'); ?>" title="<?php echo $this->translate('Rotate right'); ?>"></button>
                    <button class="rotate-left" aria-label="<?php echo $this->translate('Rotate left'); ?>" title="<?php echo $this->translate('Rotate left'); ?>"></button>
                    <button class="reset"><?php echo $this->translate('Reset'); ?></button>
                </div>
                <?php endif; ?>
            </div>
        </div>
        <?php if ($mediaIsImage): ?>
        <script>
        (function($) {
            var $zoomContainer = $('.panzoom-container');
            $('#wikitext .media-render').panzoom({
                $zoomIn: $zoomContainer.find(".zoom-in"),
                $zoomOut: $zoomContainer.find(".zoom-out"),
                $reset: $zoomContainer.find(".reset")
            });
        })(jQuery);
        </script>
        <?php endif; ?>
    </div>
</div>

<div id="html" class="section">
    <?php echo $sMedia->pageHtml(); ?>
</div>

<div class="sidebar always-open" id="reviewer-form">
    <h3>Review media</h3>
    <div class="review-fields">
        <?php
        $completed = $sMedia->completed();
        $completedBy = $sMedia->completedBy();
        ?>
        <div class="field">
            <label for="completed"><?php echo $this->translate('Completed'); ?></label>
            <?php echo $this->formCheckbox($form->get('is_completed')); ?>
            <?php if ($completed): ?>
            <div>
                <?php echo sprintf(
                    $this->translate('Last completed %s by %s'),
                    $this->i18n()->dateFormat($completed, 'medium', 'short'),
                    $this->hyperlink($completedBy, $this->url('admin/scripto-user-contributions', ['user-id' => $completedBy]))
                ); ?>
            </div>
            <?php endif; ?>
        </div>
        <?php if ($sMedia->userCan('protect')): ?>
        <div class="field">
            <label for="protection_level"><?php echo $this->translate('Protection'); ?></label>
            <?php echo $this->formSelect($form->get('protection_level')); ?>
            <?php echo $this->formSelect($form->get('protection_expiry')); ?>
        </div>
        <?php endif; ?>
        <?php
        $approved = $sMedia->approved();
        $approvedBy = $sMedia->approvedBy();
        ?>
        <div class="field">
            <label for="approved"><?php echo $this->translate('Approved'); ?></label>
            <?php echo $this->formCheckbox($form->get('is_approved')); ?>
            <?php if ($approved): ?>
            <div>
                <?php echo sprintf(
                    $this->translate('Last approved %s by %s'),
                    $this->i18n()->dateFormat($approved, 'medium', 'short'),
                    $approvedBy
                        ? $approvedBy->link($approvedBy->name())
                        : $this->translate('Unknown')
                    ); ?>
            </div>
            <?php endif; ?>
        </div>
    </div>
    <h3><?php echo $this->translate('Metadata'); ?></h3>
    <div class="metadata">
        <div class="meta-group">
            <h4><?php echo $this->translate('Item'); ?></h4>
            <div class="value"><?php echo $sItem->link($item->displayTitle()); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Project'); ?></h4>
            <div class="value"><?php echo $project->link($project->title()); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Status'); ?></h4>
            <div class="value"><?php echo $this->translate($sMedia->status()); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Last synced'); ?></h4>
            <div class="value"><?php echo $this->i18n()->dateFormat($sMedia->synced(), 'long', 'medium'); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Last edited'); ?></h4>
            <?php $edited = $sMedia->edited(); ?>
            <div class="value"><?php echo $edited
                ? sprintf(
                    '%s by %s',
                    $this->i18n()->dateFormat($sMedia->edited(), 'long', 'medium'),
                    $this->hyperlink($sMedia->editedBy(), $this->url('admin/scripto-user-contributions', ['user-id' => $sMedia->editedBy()]))
                ) : $this->translate('Not edited'); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Last completed'); ?></h4>
            <?php $completed = $sMedia->completed(); ?>
            <div class="value"><?php echo $completed
                ? sprintf(
                    '%s by %s',
                    $this->i18n()->dateFormat($sMedia->completed(), 'long', 'medium'),
                    $this->hyperlink($sMedia->completedBy(), $this->url('admin/scripto-user-contributions', ['user-id' => $sMedia->completedBy()]))
                ) : $this->translate('Not completed'); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Last approved'); ?></h4>
            <?php
            $approved = $sMedia->approved();
            $approvedBy = $sMedia->approvedBy();
            ?>
            <div class="value"><?php echo $approved
                ? sprintf(
                    '%s by %s',
                    $this->i18n()->dateFormat($sMedia->approved(), 'long', 'medium'),
                    $approvedBy
                        ? $approvedBy->link($approvedBy->name())
                        : $this->translate('Unknown')
                    )
                : $this->translate('Not approved'); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('MediaWiki page'); ?></h4>
            <?php $page = $sMedia->page(); ?>
            <div class="value"><?php echo $this->hyperlink($sMedia->pageTitle(), $page['fullurl']); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Omeka media'); ?></h4>
            <div class="value"><?php echo $media->link($media->displayTitle()); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Omeka item'); ?></h4>
            <div class="value"><?php echo $item->link($item->displayTitle()); ?></div>
        </div>
        <div class="meta-group">
            <h4><?php echo $this->translate('Description'); ?></h4>
            <?php $description = $media->displayDescription(); ?>
            <div class="value"><?php echo $description ? $this->escapeHtml($description) : $this->translate('No description'); ?></div>
        </div>
    </div>
</div>

<?php echo $this->form()->closeTag(); ?>
